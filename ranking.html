<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script defer src="font/svg-with-js/js/fontawesome-all.js"></script>
		<title>Ranking MTM</title>
		<script>
			var Mp;
			var codigoGeral;
			var bonsPremios = ["PS4", "Notebook", "Ingresso pro Star Wars"];
			var okPremios = ["Spinner", "Caixa de Bombom", "Ursinho"];

			function init(){

				codigoGeral = localStorage.getItem("codigoGeral");
				if(codigoGeral==null){
					codigoGeral = 0;
				}

				var dadosTxt = localStorage.getItem("dados");
				Mp = JSON.parse(dadosTxt);
				if(Mp==null){
					Mp = [];
				}
				montarTabelaHTML();
			}

			function crescente(a,b) {
				if (parseInt(a.pontuacao) < parseInt(b.pontuacao))
					return -1;
				if (parseInt(a.pontuacao) > parseInt(b.pontuacao))
					return 1;
				return 0;
			}

			function decrescente(a,b) {
				if (parseInt(a.pontuacao) > parseInt(b.pontuacao))
					return -1;
				if (parseInt(a.pontuacao) < parseInt(b.pontuacao))
					return 1;
				return 0;
			}

			function ordenarCrescente() {
				Mp.sort(crescente);
				montarTabelaHTML();
			}

			function ordenarDecrescente() {
				Mp.sort(decrescente);
				montarTabelaHTML();
			}

			function enviar(){
				//Resgatar dados do formulário
				var campoNome = document.getElementById("nome");
				var campoIdade = document.getElementById("idade");
				var campoPonto = document.getElementById("pontuacao");
				codigoGeral++;
				var p = {
					"id" : codigoGeral,
					"nome" : campoNome.value,
					"idade" : campoIdade.value,
					"pontuacao": campoPonto.value
				};

				//Adicionar esta pessoa na Matriz Mp
				Mp.push(p);
				salvar();

				montarTabelaHTML();
			}

			function salvar(){
				var MpTXT = JSON.stringify(Mp);
				localStorage.setItem("dados", MpTXT);
				localStorage.setItem("codigoGeral", codigoGeral);
			}
			//MONTA TABELA -------------------
			function montarTabelaHTML(){
				var linhas = "";
				for(var i=0; i<Mp.length; i++){
					var pessoa = Mp[i];
					linhas += "<tr>";
					linhas += "<td>"+pessoa.id+"</td>";
					linhas += "<td>"+pessoa.nome+"</td>";
					linhas += "<td>"+pessoa.idade+"</td>";
					linhas += "<td>"+pessoa.pontuacao+"</td>";
					linhas += "<td><a href='javascript:void(0)' onclick='excluir("+i+")'><i class='fas fa-trash-alt'></i></a></td>";
					linhas += "<td><a href='javascript:void(0)' onclick='pegarPremio("+i+")'><i class='fas fa-gift'></i></a></td>";
					linhas += "</tr>";
				}
				var tbody = document.getElementById("lista");
				tbody.innerHTML = linhas;
			}

			function excluir(indice){
				var pe = Mp[indice];
				var conf = confirm("Deseja excluir o "+pe.nome+"?");
				if(conf==true){
					Mp.splice(indice, 1);
				}
				salvar();
				montarTabelaHTML();
			}

			function resetar(){
				Mp = [];
				codigoGeral = 0;
				salvar();
				montarTabelaHTML();
			}

			function pesquisar(){
				var codPesq = document.getElementById("pesquisa").value;
				var indicePesq = -1;

				for(var i=0; i<Mp.length; i++){
					var pe = Mp[i];
					if(pe.id == codPesq){
						indicePesq = i;
						break;
					}
				}

				if(indicePesq!=-1){
					var pessoaPesq = Mp[indicePesq];
					alert(pessoaPesq.nome+" "+pessoaPesq.idade);
				}else{
					alert("Nada encontrado");
				}
			}

			function pesquisaPorInicialNome(){
				var nome = document.getElementById("pesquisaInicial").value;
				var Mres = [];
				for(var i=0; i<Mp.length; i++){
					if(Mp[i].nome.startsWith(nome)){
						Mres.push(Mp[i]);
					}
				}
				montarTabelaPesquisa(Mres);
			}

			function pesquisaPorNome(){
				var nome = document.getElementById("pesquisaNomeCompleto").value;
				var Mres = [];
				for(var i=0; i<Mp.length; i++){
					if(Mp[i].nome == nome){
						Mres.push(Mp[i]);
					}
				}
				montarTabelaPesquisa(Mres);
			}

			function montarTabelaPesquisa(Mres){
				var linhas = "";
				for(var i=0; i<Mres.length; i++){
					var pessoa = Mres[i];
					linhas += "<tr>";
					linhas += "<td>"+pessoa.id+"</td>";
					linhas += "<td>"+pessoa.nome+"</td>";
					linhas += "<td>"+pessoa.idade+"</td>";
					linhas += "<td>"+pessoa.pontuacao+"</td>";
					linhas += "<td><a href='javascript:void(0)' onclick='excluir("+i+")'><i class='fas fa-trash-alt'></i></a></td>";
					linhas += "<td><a href='javascript:void(0)' onclick='pegarPremio("+i+")'><i class='fas fa-gift'></i></a></td>";
					linhas += "</tr>";
				}
				var tbody = document.getElementById("lista");
				tbody.innerHTML = linhas;
			}

			function fazerMedia() {
				var soma = 0;
				for(var i=0; i<Mp.length; i++){
					var pessoa = Mp[i];
					soma += parseFloat(pessoa.pontuacao);
				}
				return soma/Mp.length;
			}

			function pegarPremio(indice){
				var pe = Mp[indice];
				var media = fazerMedia();
				if (parseFloat(pe.pontuacao) >= media) {
	    			var aleatorio = Math.floor((Math.random() * bonsPremios.length));
					alert("O "+ pe.nome +" ganhou " + bonsPremios[aleatorio]);
				} else {
	    			var aleatorio = Math.floor((Math.random() * okPremios.length));
					alert("O "+ pe.nome +" ganhou " + okPremios[aleatorio]);
				}
			}
		</script>
	</head>
	<body onload="init()">
		<input type="text" id="pesquisaInicial" placeholder="Pesquisar por inicial">
		<button type="button" name="button" onclick="pesquisaPorInicialNome()"><i class="fas fa-search"></i></button>
		<br>
		<input type="text" id="pesquisaNomeCompleto" placeholder="Pesquisar por nome completo">
		<button type="button" name="button" onclick="pesquisaPorNome()"><i class="fas fa-search"></i></button>
		<br>
		<button onclick="montarTabelaHTML()">LIMPAR PESQUISA</button>
		<br>
		<button onclick="ordenarCrescente()"><i class="fas fa-sort-amount-up"></i></button>
		<br>
		<button onclick="ordenarDecrescente()"><i class="fas fa-sort-amount-down"></i></button>
		<br>
		<button onclick="resetar()">Resetar <i class="fas fa-undo"></i></button>
		<hr>
		<input type="text" id="pesquisa" placeholder="Pesquise código">
		<button type="button" name="button" onclick="pesquisar()"><i class="fas fa-search"></i></button>


	<br><br>
		<label>
			Nome:
			<input type="text" id="nome">
		</label>
		<br>

		<label>
			Idade:
			<input type="text" id="idade">
		</label>
		<br>

		<label>
			Pontuação:
			<input type="text" id="pontuacao">
		</label>
		<br>
		<button onclick="enviar()">Salvar <i class="fas fa-save"></i></button>
		<hr>
		<table border="1">
			<thead>
				<tr>
					<th>Codigo</th>
					<th>Nome</th>
					<th>Idade</th>
					<th>Pontuacao</th>
					<th>Excluir</th>
					<th>Premio</th>
				</tr>
			</thead>
			<tbody id="lista">
			</tbody>
		</table>
	</body>
</html>
